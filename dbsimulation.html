<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Database Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        .form-input {
            @apply w-full px-4 py-2 bg-gray-700 text-gray-100 rounded-lg shadow-inner border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors;
        }
        .btn {
            @apply font-semibold text-white rounded-[5px] shadow-lg transition-all duration-300 transform hover:scale-105 hover:shadow-xl;
        }
        .btn-gradient {
            background-image: linear-gradient(45deg, #4f46e5 0%, #3b82f6 100%);
        }
        .btn-danger {
            @apply text-sm font-semibold text-white bg-red-600 rounded-[5px] shadow-md transition-all duration-200 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500;
        }
        .card {
            @apply bg-gray-800 p-8 rounded-2xl shadow-2xl backdrop-blur-md bg-opacity-70 border border-gray-700;
        }
        .table-container {
            @apply mt-6 overflow-x-auto;
        }
        table {
            @apply w-full text-sm text-left text-gray-300;
        }
        thead {
            @apply text-xs uppercase text-gray-400 bg-gray-700 rounded-t-lg;
        }
        th, td {
            @apply px-4 py-3;
        }
        tbody tr {
            @apply border-b border-gray-700 transition-colors duration-200 hover:bg-gray-700;
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-12 max-w-7xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Interactive Database Simulation</h1>
            <p class="mt-2 text-lg text-gray-400">A hands-on demonstration of database tables and relationships.</p>
            <div class="mt-6 text-sm text-gray-400">
                <span>User ID: </span><span id="userId" class="font-mono bg-gray-700 px-2 py-1 rounded-md text-gray-300">Loading...</span>
            </div>
            <div class="mb-6">
                <span class="text-sm font-medium text-gray-300 block mb-2">Choose ID Type:</span>
                <div class="flex items-center gap-4">
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-blue-600" name="idType" value="uuid" checked>
                        <span class="ml-2 text-gray-400">UUID</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" class="form-radio text-blue-600" name="idType" value="int">
                        <span class="ml-2 text-gray-400">Integer ID</span>
                    </label>
                </div>
            </div>
        </header>

        <div id="message-box" class="hidden p-4 mb-6 text-sm text-center rounded-lg" role="alert"></div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            
            <!-- Students Section -->
            <div class="card">
                <h2 class="text-3xl font-bold mb-4 text-blue-300 flex items-center gap-2">
                    <span class="text-xl">ðŸŽ“</span> Students Table
                </h2>
                <p class="text-sm text-gray-400 mb-6">
                    Each student has a unique <strong class="text-blue-400">Primary Key (Student ID)</strong>.
                </p>
                <form id="add-student-form">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="student-name" class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                            <input type="text" id="student-name" class="form-input" required>
                        </div>
                        <div>
                            <label for="student-major" class="block text-sm font-medium text-gray-300 mb-1">Major</label>
                            <input type="text" id="student-major" class="form-input" required>
                        </div>
                    </div>
                    
                    <!-- ID Type Selection -->
                    

                    <button type="submit" class="btn btn-gradient w-full py-2">Add Student</button>
                </form>

                <div class="table-container">
                    <table class="rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Major</th>
                                <th>Student ID (PK)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <!-- Student data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Courses Section -->
            <div class="card">
                <h2 class="text-3xl font-bold mb-4 text-emerald-300 flex items-center gap-2">
                    <span class="text-xl">ðŸ“š</span> Courses Table
                </h2>
                <p class="text-sm text-gray-400 mb-6">
                    A <strong class="text-emerald-400">Foreign Key</strong> links each course to a student.
                </p>
                <form id="add-course-form">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="course-name" class="block text-sm font-medium text-gray-300 mb-1">Course Name</label>
                            <input type="text" id="course-name" class="form-input" required>
                        </div>
                        <div>
                            <label for="student-select" class="block text-sm font-medium text-gray-300 mb-1">Enrolled Student</label>
                            <select id="student-select" class="form-input" required>
                                <option value="" disabled selected>Select a student</option>
                                <!-- Student options will be populated here -->
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-gradient w-full py-2">Add Course</button>
                </form>

                <div class="table-container">
                    <table class="rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th>Course Name</th>
                                <th>Student</th>
                                <th>Student ID (FK)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table-body">
                           <!-- Course data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        const userIdElement = document.getElementById('userId');
        const messageBox = document.getElementById('message-box');
        
        const addStudentForm = document.getElementById('add-student-form');
        const studentNameInput = document.getElementById('student-name');
        const studentMajorInput = document.getElementById('student-major');
        const studentsTableBody = document.getElementById('students-table-body');
        const idTypeRadios = document.getElementsByName('idType');
        
        const addCourseForm = document.getElementById('add-course-form');
        const courseNameInput = document.getElementById('course-name');
        const studentSelect = document.getElementById('student-select');
        const coursesTableBody = document.getElementById('courses-table-body');
        
        let studentsCollection, coursesCollection;
        let unsubscribeStudents, unsubscribeCourses;

        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;
                userIdElement.textContent = userId;

                studentsCollection = collection(db, `artifacts/${appId}/users/${userId}/students`);
                coursesCollection = collection(db, `artifacts/${appId}/users/${userId}/courses`);

                setupListeners();
            } else {
                userIdElement.textContent = 'Authenticating...';
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication Error:", error);
                    userIdElement.textContent = 'Authentication Failed';
                    showMessage("Could not authenticate. Please refresh the page.", true);
                }
            }
        });

        async function addStudent(e) {
            e.preventDefault();
            const studentName = studentNameInput.value.trim();
            const studentMajor = studentMajorInput.value.trim();
            const idType = [...idTypeRadios].find(radio => radio.checked).value;

            if (!studentName || !studentMajor) {
                showMessage("Please fill in both fields.", true);
                return;
            }

            try {
                if (idType === 'int') {
                    const snapshot = await getDocs(studentsCollection);
                    const docIds = snapshot.docs.map(d => parseInt(d.id, 10)).filter(id => !isNaN(id));
                    const newId = (docIds.length > 0 ? Math.max(...docIds) : 0) + 1;
                    await setDoc(doc(studentsCollection, newId.toString()), {
                        name: studentName,
                        major: studentMajor
                    });
                } else {
                    await addDoc(studentsCollection, {
                        name: studentName,
                        major: studentMajor
                    });
                }
                
                showMessage("Student added successfully!");
                addStudentForm.reset();
            } catch (error) {
                console.error("Error adding student: ", error);
                showMessage("Failed to add student.", true);
            }
        }

        async function addCourse(e) {
            e.preventDefault();
            const courseName = courseNameInput.value.trim();
            const selectedOption = studentSelect.options[studentSelect.selectedIndex];
            const studentId = selectedOption.value;
            const studentName = selectedOption.text.split(' (')[0];

            if (courseName && studentId) {
                try {
                    await addDoc(coursesCollection, {
                        name: courseName,
                        studentId: studentId,
                        studentName: studentName
                    });
                    showMessage("Course added successfully!");
                    addCourseForm.reset();
                } catch (error) {
                    console.error("Error adding course: ", error);
                    showMessage("Failed to add course.", true);
                }
            }
        }

        async function deleteItem(collectionRef, id, itemName) {
             try {
                await deleteDoc(doc(collectionRef, id));
                showMessage(`${itemName} deleted successfully!`);
            } catch (error) {
                console.error(`Error deleting ${itemName}: `, error);
                showMessage(`Failed to delete ${itemName}.`, true);
            }
        }

        function setupListeners() {
            if (unsubscribeStudents) unsubscribeStudents();
            unsubscribeStudents = onSnapshot(studentsCollection, (snapshot) => {
                studentsTableBody.innerHTML = '';
                studentSelect.innerHTML = '<option value="" disabled selected>Select a student</option>';
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;

                    // Populate students table
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="font-medium">${student.name}</td>
                        <td>${student.major}</td>
                        <td class="font-mono text-xs">${studentId}</td>
                        <td><button class="btn-danger delete-student" data-id="${studentId}">Delete</button></td>
                    `;
                    studentsTableBody.appendChild(tr);

                    // Populate student dropdown
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = `${student.name} (${student.major})`;
                    studentSelect.appendChild(option);
                });
            });

            if (unsubscribeCourses) unsubscribeCourses();
            unsubscribeCourses = onSnapshot(coursesCollection, (snapshot) => {
                coursesTableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const course = doc.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="font-medium">${course.name}</td>
                        <td>${course.studentName || 'N/A'}</td>
                        <td class="font-mono text-xs">${course.studentId}</td>
                        <td><button class="btn-danger delete-course" data-id="${doc.id}">Delete</button></td>
                    `;
                    coursesTableBody.appendChild(tr);
                });
            });
        }
        
        addStudentForm.addEventListener('submit', addStudent);
        addCourseForm.addEventListener('submit', addCourse);

        document.addEventListener('click', (e) => {
            if(e.target && e.target.classList.contains('delete-student')) {
                const id = e.target.getAttribute('data-id');
                deleteItem(studentsCollection, id, 'Student');
            }
            if(e.target && e.target.classList.contains('delete-course')) {
                const id = e.target.getAttribute('data-id');
                deleteItem(coursesCollection, id, 'Course');
            }
        });

    </script>
</body>
</html>
